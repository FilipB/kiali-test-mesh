- name: Add Service Mesh Member to namespaces
  k8s:
    state: "{{ state }}"
    definition: "{{ lookup('template', 'templates/istio/smm.yml') }}"
  ignore_errors: true  

- name: "Create {{ item.name }} Service "
  k8s:
    state: "{{ state }}"
    definition: "{{ lookup('template', item.file) }}"
  with_items:
    - { name: "Customer", namespace: '{{ meta.namespace }}', file: 'templates/customer/customer-service.yml'}
    - { name: "Preference", namespace: '{{ meta.namespace }}', file: 'templates/preference/preference-service.yml'}
    - { name: "Recommendation", namespace: '{{ meta.namespace }}', file: 'templates/recommendation/recommendation-service.yml'}

- name: "Create {{ item.name }}"
  k8s:
    state: "{{ state }}"
    definition: "{{ lookup('template', item.file) }}"
  with_items:
  - { name: 'customer-v1', namespace: '{{ meta.namespace }}', file: 'templates/customer/deployment-v1.yml', sidecar: true }
  - { name: 'preference-v1', namespace: '{{ meta.namespace }}', file: 'templates/preference/deployment-v1.yml', sidecar: true }
  - { name: 'preference-v1', namespace: '{{ meta.namespace }}', file: 'templates/preference/deployment-v2.yml', sidecar: true }
  - { name: 'recommendation-v1', namespace: '{{ meta.namespace }}', file: 'templates/recommendation/deployment-v1.yml', sidecar: true }
  - { name: 'recommendation-v2', namespace: '{{ meta.namespace }}', file: 'templates/recommendation/deployment-v2.yml', sidecar: true }

- name: Create Openshift Route
  k8s:
    state: "{{ state }}"
    definition: "{{ lookup('template', item.file) }}"
  with_items:
   - {file: 'templates/istio/customer-route.yml'}
  register: route

- name: Deploy Customer Istio Gateway
  k8s:
    state: "{{ state }}"
    definition: "{{ lookup('template', item.file) }}"
  with_items:
   - {file: 'templates/istio/customer-gateway.yml'}
   - {file: 'templates/istio/customer-vs.yml'}

- name: Deploy Tutorial Destination Rules
  k8s:
    state: "{{ state }}"
    definition: "{{ lookup('template', item.file) }}"
  with_items:
   - {file: 'templates/istio/customer-dr.yml'}
   - {file: 'templates/istio/preference-dr.yml'}
   - {file: 'templates/istio/recommendation-dr.yml'}
  
- name: Set Full Route for Traffic Generator
  set_fact:
    full_route: "http://{{ route.results[0]['result']['spec']['host'] }}"

- name: Get State for Traffic Generator
  set_fact:
    state_traffic_generator: "{{ state }}"

- name: Create the traffic generator
  include_role: 
    name: traffic-generator
  vars:
    namespace: "{{ meta.namespace }}"
    route: "{{ full_route }}"
    state: "{{ state_traffic_generator }}"
